# 問題 3.20 解答

## 手続きを使った対の表現

```scheme
(define (cons x y)
  (define (set-x! v) (set! x v))
  (define (set-y! v) (set! y v))
  (define (dispatch m)
    (cond ((eq? m 'car) x)
          ((eq? m 'cdr) y)
          ((eq? m 'set-car!) set-x!)
          ((eq? m 'set-cdr!) set-y!)
          (else (error "Undefined operation -- CONS" m))))
  dispatch)
```

```scheme
(define (car z) (z 'car))
```

```scheme
(define (cdr z) (z 'cdr))
```

```scheme
(define (set-car! z new-value)
  ((z 'set-car!) new-value)
  z)
```

```scheme
(define (set-cdr! z new-value)
  ((z 'set-cdr!) new-value)
  z)
```

## 一連の式の評価を示す環境の図

### STEP 1

```scheme
(define x (cons 1 2))
```

```
        +------------------------------------------------------------+
global->| cons:...  set-car!:...                                     |
        | car:...   set-cdr!:...                                     |
        | cdr:...                                                    |
        |                                   x:*                      |
        +-------------------------------------|----------------------+
                                              |            ^
                                              |            |
                                              |     +----------------+
                                              | E1->|x: 1            |
                                              |     |y: 2            |
                                              |     |set-x!: ...     |
                                              |     |set-y!: ...     |
                                              |     |dispatch: *     |
                                              |     +----------|-----+
                                              |                |    ^
                                              |                V    |
                                              +------------->(* *)--+
                                                              |
                                                              V
                                                   +-----------------+
                                                   |param: m         |
                                                   |body: (cond ... )|
                                                   +-----------------+
```

### STEP 2

```scheme
(define z (cons x x))
```

```
        +------------------------------------------------------------+
global->| cons:...  set-car!:...                                     |
        | car:...   set-cdr!:...                                     |
        | cdr:...                                                    |
        |       z:*                         x:*                      |
        +---------|---------------------------|----------------------+
                  |            ^              |            ^
                  |            |              |            |
                  |     +----------------+    |     +----------------+
                  | E2->|x: *-----------------+ E1->|x: 1            |
                  |     |y: *-----------------+     |y: 2            |
                  |     |set-x!: ...     |    |     |set-x!: ...     |
                  |     |set-y!: ...     |    |     |set-y!: ...     |
                  |     |dispatch: *     |    |     |dispatch: *     |
                  |     +----------|-----+    |     +----------|-----+
                  |                |    ^     |                |    ^
                  |                V    |     |                V    |
                  +------------->(* *)--+     +------------->(* *)--+
                                  |                           |
                                  |                           V
                                  |                +-----------------+
                                  +--------------->|param: m         |
                                                   |body: (cond ... )|
                                                   +-----------------+
```

### STEP 3

```scheme
(set-car! (cdr z) 17)
```

まず、set-car!が呼び出され環境E3が作られる。次に、set-car!の引数の (cdr z) が評価され環境E4が作られる。

E4の パラメーター:z は、大域環境に束縛された z の指す手続きオブジェクトである。

cdr手続きの本体 (z 'cdr) がE4内で評価され、なんやかんやあって大域環境に束縛された x の指す手続きオブジェクトがset-car!の引数に渡される。

set-car!手続きの本体が評価され以下略

```
        +---------------------------------------------------------------------------+
global->| cons:...  set-car!:...                                                    |
        | car:...   set-cdr!:...                                                    |
        | cdr:...                                                                   |
    +-->|               z:*                                x:*                      |
    |   +-----------------|----------------------------------|----------------------+
    |              ^      |                    ^             |            ^
    |              |      |                    |             |            |
+------+       +---------------------------------------------+            |              E6
|z: *  |       |   |      |                    |             |            |               |
+---|--+       |   |      |                    |             |            |               V
 ^  |      +---|--------+ |   E5        +----------------+   |     +----------------+  +-------------+
 |  |  E3->|z: *        | |    |    E2->|x: *----------------+ E1->|x: 1 -> 17      |<-|m: 'set-car! |
E4  |      |new-value:17| |    V        |y: *----------------+     |y: 2            |  +-------------+
    |      +------------+ |  +-------+  |set-x!: ...     |   |     |set-x!: ...     |
    |                     |  |m: 'cdr|->|set-y!: ...     |   |     |set-y!: ...     |  +------+
    |                     |  +-------+  |dispatch: *     |   |     |dispatch: *     |<-|v: 17 |
    |                     |             +----------|-----+   |     +----------|-----+  +------+
    |                     |                        |    ^    |                |    ^      ^
    |                     |                        V    |    |                V    |      |
    +---------------------+--------------------->(* *)--+    +------------->(* *)--+     E7
                                                  |                          |
                                                  |                          V
                                                  |               +-----------------+
                                                  +-------------->|param: m         |
                                                                  |body: (cond ... )|
                                                                  +-----------------+
```

### STEP 4

```scheme
(car x)
=> 17
```

```
        +--------------------------------------------------------------------+
global->| cons:...  set-car!:...                                             |
        | car:...   set-cdr!:...                                             |
        | cdr:...                                                            |
        |               z:*                         x:*                      |
        +-----------------|---------------------------|----------------------+
                   ^      |            ^              |            ^
                   |      |            |              |            |
               +--------------------------------------+            |
               |   |      |            |              |            |
               |   |      |            |              |            |
           +---|-----+    |     +----------------+    |     +----------------+    E9
       E8->|z: *     |    | E2->|x: *-----------------+ E1->|x: 17           |     |
           +---------+    |     |y: *-----------------+     |y: 2            |     V
                          |     |set-x!: ...     |    |     |set-x!: ...     |   +--------+
                          |     |set-y!: ...     |    |     |set-y!: ...     |<--|m: 'car |
                          |     |dispatch: *     |    |     |dispatch: *     |   +--------+
                          |     +----------|-----+    |     +----------|-----+
                          |                |    ^     |                |    ^
                          |                V    |     |                V    |
                          +------------->(* *)--+     +------------->(* *)--+
                                          |                           |
                                          |                           V
                                          |                +-----------------+
                                          +--------------->|param: m         |
                                                           |body: (cond ... )|
                                                           +-----------------+
```
