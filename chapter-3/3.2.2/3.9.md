# 問題 3.9 回答

## 再帰版

```scheme
(define (factorial n)
  (if (= n 1)
      1
      (* n (factorial (- n 1)))))
```

まず、factorialが呼び出され、環境E1が作られる。

factorialの本体の評価中に、`(* n (factorial (- n 1)))` の箇所で、factorialが呼び出される。

factorialが指す環境は大域環境なので、大域環境の直下に、E2,E2...E6 が次々と作られる。

```
         +---------------------------------------------------------------------+
 global->|factorial: ...                                                       |
         +---------------------------------------------------------------------+
(factorial 6)   ^           ^           ^           ^           ^           ^
                |           |           |           |           |           |
             +-----+     +-----+     +-----+     +-----+     +-----+     +-----+
         E1->| n:6 | E2->| n:5 | E3->| n:4 | E4->| n:3 | E5->| n:2 | E6->| n:1 |
             +-----+     +-----+     +-----+     +-----+     +-----+     +-----+

             (if (= n 1)
                 1
                 (* n (factorial (- n 1))))
```

factorialの再帰呼び出し時は、`(* n (factorial (- n 1)))`の乗算の引数の評価中なので、E1,E2...E6 は**同時に存在**している。

(再帰が深くなるほど使用する環境のスペースは増大する!)

## 反復版

```scheme
(define (factorial n)
  (fact-iter 1 1 n))

(define (fact-iter product counter max-count)
  (if (> counter max-count)
      product
      (fact-iter (* counter product)
                 (+ counter 1)
                 max-count)))
```

まず、factorialが呼び出され、大域環境にE1が作られる。

```
         +------------------------------+
 global->|factorial: ...                |
         |fact-iter: ...                |
         +------------------------------+
(factorial 6)      ^
                   |
                 +---+
             E1->|n:1|
                 +---+
           (fact-iter 1 1 n)

```

次に、factorialの本体が評価され、fact-iterが呼び出され、環境E2が大域環境に作られる。

このとき、factorialの評価はすでに終わってしまっているので、他からのポインタもないE1は無効となる。

```
         +--------------------------------------------+
 global->|factorial: ...                              |
         |fact-iter: ...                              |
         +--------------------------------------------+
(factorial 6)               ^
                            |
                          +---+
                      E2->|p:1|
                          |c:1|
                          |m:6|
                          +---+
                      (if (> counter max-count)
                            product
                            (fact-iter (* counter product)
                                       (+ counter 1)
                                             max-count))
```

さらに、fact-iterの本体が評価され、`(fact-iter (* counter ...`が呼び出され、環境E3が大域環境に作られる。

このとき、fact-iter(E2内)の評価はすでに終わってしまっているので、他からのポインタもないE2は無効となる。

```
         +--------------------------------------------+
 global->|factorial: ...                              |
         |fact-iter: ...                              |
         +--------------------------------------------+
(factorial 6)               ^
                            |
                          +---+
                      E3->|p:1|
                          |c:2|
                          |m:6|
                          +---+
                      (if (> counter max-count)
                            product
                            (fact-iter (* counter product)
                                       (+ counter 1)
                                             max-count))
```

この手順を繰り返し、以下のように E4,E5...E8 が作られていく。

面倒なので、以下のように1つの図にまとめてしまう。

```
         +-----------------------------------------------------------+
 global->|factorial: ...                                             |
         |fact-iter: ...                                             |
         +-----------------------------------------------------------+
(factorial 6)      ^         ^         ^           ^           ^
                   |         |         |           |           |
                 +---+     +---+     +----+     +-----+     +-----+
             E4->|p:2| E5->|p:6| E6->|p:24| E7->|p:120| E8->|p:720|
                 |c:3|     |c:4|     |c:5 |     |c:6  |     |c:7  |
                 |m:6|     |m:6|     |m:6 |     |m:6  |     |m:6  |
                 +---+     +---+     +----+     +-----+     +-----+
                                (if (> counter max-count)
                                      product
                                      (fact-iter (* counter product)
                                                 (+ counter 1)
                                                 max-count))
```

fact-iterの反復呼び出し時は、E4,E5...E8 は、いずれか**1つしか存在しない**。

(末尾再帰を使うと、一定量の環境のスペースで実行できる!)

***

実はこの主張は明らかではないが、末尾再帰については5.4節で解釈系の制御構造を扱ったときに論じられるらしい。
