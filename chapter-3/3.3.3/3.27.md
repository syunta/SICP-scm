# 問題 3.27 解答

## (memo-fib 3)の計算を解析する環境の図

### STEP 1

```scheme
(define (memoize f)
  (let ((table (make-table)))
    (lambda (x)
      (let ((previously-computed-result (lookup x table)))
        (or previously-computed-result
            (let ((result (f x)))
              (insert! x result table)
              result))))))
```

分かり易くするため、letをlambdaに書き換える。

```scheme
(define (memoize f)
  ((lambda (table)
     (lambda (x)
       (let ((previously-computed-result (lookup x table)))
         (or previously-computed-result
             (let ((result (f x)))
               (insert! x result table)
               result)))))
   (make-table)))
```

### STEP 2

```scheme
(define (memoize f)
  ((lambda (table)
     (lambda (x) ... ))
   (make-table)))
```

大域環境に手続きオブジェクトがmemoizeとして束縛される。

```
        +-------------------------------+
global->|memoize:*                      |
        +--------|----------------------+
                 |    ^
                 V    |
            +--(* *)--+
            |
            V
+---------------------------+
|param: f                   |
|body: ((lambda (table)     |
|         (lambda (x) ... ))|
|       (make-table))       |
+---------------------------+
```

### STEP 3

```scheme
(define memo-fib
  (memoize (lambda (n)
             (cond ... ))))
```

lambdaで手続きオブジェクトが作られ、memoizeの引数として渡される。

memoizeが呼び出され、大域環境にE1が作られ、memoizeの本体がE1環境下で評価される。

```
        +-----------------------------------------------------------+
global->|memoize:*                                                  |
        +--------|--------------------------------------------------+
                 |    ^               ^                            ^
                 V    |               |                            |
            +--(* *)--+            +-----+                         |
            |                  E1->|f: *------------------->(* *)--+
            V                      +-----+                   |
+---------------------------+  ((lambda (table)              V
|param: f                   |     (lambda (x) ... ))   +-----------------+
|body: ((lambda (table)     |   (make-table))          |param: n         |
|         (lambda (x) ... ))|                          |body: (cond ... )|
|       (make-table)))      |                          +-----------------+
+---------------------------+
```

memoizeの本体は、使い捨ての手続きオブジェクトを作り、即座に呼び出している。

lamdaが評価され、E1環境内で手続きオブジェクトが作られる。

```
        +-----------------------------------------------------------+
global->|memoize:*                                                  |
        +--------|--------------------------------------------------+
                 |    ^               ^                            ^
                 V    |               |                            |
            +--(* *)--+            +-----+                         |
            |                  E1->|f: *------------------->(* *)--+
            V                      +-----+                   |
+---------------------------+       ^                        V
|param: f                   |       |                  +-----------------+
|body: ((lambda (table)     |    (* *)                 |param: n         |
|         (lambda (x) ... ))|     |                    |body: (cond ... )|
|       (make-table)))      |     V                    +-----------------+
+---------------------------+   +-----------------+
                                |param: table     |
                                |body: (lambda (x)|
                                |        ... )    |
                                +-----------------+
```

手続きオブジェクトを即座に呼び出し、フレームE2が作られる。

```
        +-----------------------------------------------------------+
global->|memoize:*                                                  |
        +--------|--------------------------------------------------+
                 |    ^               ^                            ^
                 V    |               |                            |
            +--(* *)--+            +-----+                         |
            |                  E1->|f: *------------------->(* *)--+
            V                      +-----+                   |
+---------------------------+       ^   ^                    V
|param: f                   |       |   |              +-----------------+
|body: ((lambda (table)     |    (* *)  |    E2        |param: n         |
|         (lambda (x) ... ))|     |     |    |         |body: (cond ... )|
|       (make-table)))      |     |     |    V         +-----------------+
+---------------------------+     |   +-------------------+
                                  |   |table: (make-table)|
                                  |   +-------------------+
                                  V
                                +-----------------+
                                |param: table     |
                                |body: (lambda (x)|
                                |        ... )    |
                                +-----------------+
```

lambdaが評価され、手続きオブジェクトを返し、defineでmemo-fibに束縛される。

E1内で作られた手続きオブジェクトは、他の部分からのポインタもないので無効となる。

```
        +----------------------------------------------------------------+
global->|memoize:*       memo-fib:*                                      |
        +--------|----------------|--------------------------------------+
                 |    ^           |        ^                            ^
                 V    |           |        |                            |
            +--(* *)--+           |     +-----+                         |
            |                     | E1->|f: *------------------->(* *)--+
            V                     |     +-----+                   |
+---------------------------+     |       ^                       V
|param: f                   |     |       |                    +-----------------+
|body: ((lambda (table)     |     |     +-------------------+  |param: n         |
|         (lambda (x) ... ))|     | E2->|table: (make-table)|  |body: (cond ... )|
|       (make-table)))      |     |     +-------------------+  +-----------------+
+---------------------------+     |              ^
                                  |              |
                                  +------>(* *)--+
                                           |
                                           V
                                        +----------------+
                                        |param: x        |
                                        |body: (let ... )|
                                        +----------------+
```

### STEP 4

```scheme
(memo-fib 3)
```

memo-fibが呼び出され、E2環境下にE3が作られる。

memo-fibの本体には、

```scheme
(let ((previously-computed-result (lookup x table)))
  ... )
```

があるので、E3環境下にE4が作られる。(lambdaで書き換えの下りは省略)

(lookup 3 table) では何も見つからず、

```scheme
(let ((result (f x)))
  ... )
```

の節が評価され、E4環境下にE5が作られる。

手続きfが呼び出され、大域環境にE6が作られる。

```
        +----------------------------------------------------------------+
global->|memo-fib:*                                                      |
        +---------|------------------------------------------------------+
                  |        ^                        ^                 ^
                  |        |                        |                 |
                  |     +-----+                     |               +----+
                  | E1->|f: *------------------->(* *)          E6->|n: 3|
                  |     +-----+                   |                 +----+
                  |       ^                       V                (cond ... )
                  |       |                    +-----------------+
                  |     +-------------------+  |param: n         |
                  | E2->|table: (make-table)|  |body: (cond ... )|
                  |     +-------------------+  +-----------------+
                  |          ^         ^
                  |          |         |
                  +------>(* *)      +----+
                           |     E3->|x: 3|
                           V         +----+
             +----------------+        ^
             |param: x        |        |
             |body: (let ... )|      +--------------------------+
             +----------------+  E4->|previously-computed-result|
                                     | : (lookup 3 table)       |
                                     +--------------------------+
                                       ^
                                       |
                                     +---------+
                                 E5->|result: ?|
                                     +---------+
```

fの本体がE6環境下で評価され、(memo-fib 2)が呼び出され、E2環境下にE7が作られる。

memo-fibの本体には、

```scheme
(let ((previously-computed-result (lookup x table)))
  ... )
```

があるので、E7環境下にE8が作られる。

(lookup 2 table) では何も見つからず、

```scheme
(let ((result (f x)))
  ... )
```

の節が評価され、E8環境下にE9が作られる。

手続きfが呼び出され、大域環境にE10が作られる。

```
        +-------------------------------------------------------------------------------------+
global->|memo-fib:*                                                                           |
        +---------|---------------------------------------------------------------------------+
                  |        ^                                ^                 ^              ^
                  |        |                                |                 |              |
                  |     +-----+                             |               +----+         +----+
                  | E1->|f: *--------------------------->(* *)          E6->|n: 3|    E10->|n: 2|
                  |     +-----+                           |                 +----+         +----+
                  |       ^                               V                (cond ... )    (cond ... )
                  |       |                            +-----------------+
                  |     +---------------------------+  |param: n         |
                  | E2->|table: (make-table)        |  |body: (cond ... )|
                  |     +---------------------------+  +-----------------+
                  |          ^         ^           ^
                  |          |         |           |
                  +------>(* *)      +----+      +----+
                           |     E3->|x: 3|  E7->|x: 2|
                           V         +----+      +----+
             +----------------+        ^           ^
             |param: x        |        |           |
             |body: (let ... )|        |         +--------------------------+
             +----------------+        |     E8->|previously-computed-result|
                                       |         | : (lookup 2 table)       |
                                       |         +--------------------------+
                                       |                                ^
                                     +--------------------------+       |
                                 E4->|previously-computed-result|     +---------+
                                     | : (lookup 3 table)       | E9->|result: ?|
                                     +--------------------------+     +---------+
                                       ^
                                       |
                                     +---------+
                                 E5->|result: ?|
                                     +---------+
```

fの本体がE10環境下で評価され、(memo-fib 1)が呼び出され、E2環境下にE11が作られる。

memo-fibの本体には、

```scheme
(let ((previously-computed-result (lookup x table)))
  ... )
```

があるので、E11環境下にE12が作られる。

(lookup 1 table) では何も見つからず、

```scheme
(let ((result (f x)))
  ... )
```

の節が評価され、E12環境下にE13が作られる。

手続きfが呼び出され、大域環境にE14が作られる。

fの本体がE14環境下で評価され、1が返される。この時、key:1,value:1 のレコードがE2内のtableに挿入される。

呼び出し元のE10に戻り、

```scheme
(+ (memo-fib 1)
   (memo-fib 0))
```

(memo-fib 0)が呼び出され、同様にして0が返される。この時、key:0,value:0 のレコードがE2内のtableに挿入される。

E9環境下で評価された (f 2) の結果がresultに返される。この時、key:2,value:1 のレコードがE2内のtableに挿入される。

```
        +------------------------------------------------------------------------------------------------------------------------+
global->|memo-fib:*                                                                                                              |
        +---------|--------------------------------------------------------------------------------------------------------------+
                  |        ^                                                     ^        ^           ^           ^           ^
                  |        |                                                     |        |           |           |           |
                  |     +-----+                                                  |      +----+      +----+      +----+      +----+
                  | E1->|f: *------------------------------------------------>(* *) E6->|n: 3| E10->|n: 2| E14->|n: 1| E18->|n: 0|
                  |     +-----+                                                |        +----+      +----+      +----+      +----+
                  |       ^                                                    |       (cond ... )
                  |       |                                                    V
                  |     +-------------------------------------------------+  +-----------------+
                  | E2->|table: 1 => 1                                    |  |param: n         |
                  |     |       0 => 0                                    |  |body: (cond ... )|
                  |     |       2 => 1                                    |  +-----------------+
                  |     +-------------------------------------------------+
                  |          ^        ^          ^           ^           ^
                  |          |        |          |           |           |
                  +------>(* *)     +----+     +----+      +----+      +----+
                           |    E3->|x: 3| E7->|x: 2| E11->|x: 1| E15->|x: 0|
                           V        +----+     +----+      +----+      +----+
             +----------------+       ^          ^           ^           ^
             |param: x        |       |          |           |           |
             |body: (let ... )|       |          |           |         +--------------------------+
             +----------------+       |          |           |    E16->|previously-computed-result|
                                      |          |           |         | : (lookup 0 table)       |
                                      |          |           |         +--------------------------+
                                      |          |           |                                 ^
                                      |          |         +--------------------------+        |
                                      |          |    E12->|previously-computed-result|      +---------+
                                      |          |         | : (lookup 1 table)       | E17->|result: 0|
                                      |          |         +--------------------------+      +---------+
                                      |          |                                 ^
                                      |        +--------------------------+        |
                                      |    E8->|previously-computed-result|      +---------+
                                      |        | : (lookup 2 table)       | E13->|result: 1|
                                      |        +--------------------------+      +---------+
                                      |                                ^
                                    +--------------------------+       |
                                E4->|previously-computed-result|     +---------+
                                    | : (lookup 3 table)       | E9->|result: 1|
                                    +--------------------------+     +---------+
                                      ^
                                      |
                                    +---------+
                                E5->|result: ?|
                                    +---------+
```

E7~E18の環境は、他からのポインタもないので無効となっている。

呼び出し元のE6に戻り、

```scheme
(+ (memo-fib 2)
   (memo-fib 1))
```

(memo-fib 1)が呼び出され、E2環境下にE19が作られる。

memo-fibの本体には、

```scheme
(let ((previously-computed-result (lookup x table)))
  ... )
```

があるので、E19環境下にE20が作られる。

(lookup 1 table) で1が見つかり、1が返される。

(+ 1 1) となり、

E5環境下で評価された (f 3) の結果がresultに返される。この時、key:3,value:2 のレコードがE2内のtableに挿入される。

```
        +--------------------------------------------------------------+
global->|memo-fib:*                                                    |
        +---------|----------------------------------------------------+
                  |        ^                              ^        ^
                  |        |                              |        |
                  |     +-----+                           |      +----+
                  | E1->|f: *------------------------->(* *) E6->|n: 3|
                  |     +-----+                         |        +----+
                  |       ^                             |       (cond ... )
                  |       |                             V
                  |     +--------------------------+  +-----------------+
                  | E2->|table: 1 => 1             |  |param: n         |
                  |     |       0 => 0             |  |body: (cond ... )|
                  |     |       2 => 1             |  +-----------------+
                  |     |       3 => 2             |
                  |     +--------------------------+
                  |          ^        ^           ^
                  |          |        |           |
                  +------>(* *)     +----+      +----+
                           |    E3->|x: 3| E19->|x: 1|
                           V        +----+      +----+
             +----------------+       ^           ^
             |param: x        |       |           |
             |body: (let ... )|       |         +--------------------------+
             +----------------+       |    E20->|previously-computed-result|
                                      |         | : (lookup 1 table)       |
                                      |         +--------------------------+
                                      |
                                    +--------------------------+
                                E4->|previously-computed-result|
                                    | : (lookup 3 table)       |
                                    +--------------------------+
                                      ^
                                      |
                                    +---------+
                                E5->|result: 2|
                                    +---------+
```

最後に、(memo-fib 3)の結果として、2が返される。

## memo-fibがn番目のFibonacci数をnに比例したステップ数で計算出来る理由

1.2.2 図1.5 (fib 5)の計算で生成された木構造再帰プロセス

```
(fib 5)---------------------------------(fib 3)---------(fib 1)
   |                                       |               |
(fib 4)-----------------(fib 2)-(fib 0) (fib 2)-(fib 0)    1
   |                       |       |       |       |
(fib 3)---------(fib 1) (fib 1)    0    (fib 1)    0
   |               |       |               |
(fib 2)-(fib 0)    1       1               1
   |       |
(fib 1)    0
   |
   1
```

の例で考える。重複部分をメモ化した図は以下のようになる。

```
(fib 5)-------------------------(fib 3)
   |                               |
(fib 4)-----------------(fib 2)    2
   |                       |
(fib 3)---------(fib 1)    1
   |               |
(fib 2)-(fib 0)    1
   |       |
(fib 1)    0
   |
   1
```

fibの呼び出し回数は9回で、2n - 1 となり、nに比例している。

## memo-fibを単に(memoize fib)と定義してもやはり働くだろうか.

最終的な結果だけがメモ化される。

実行過程の重複部分はメモ化されないので期待通りの働きはしない。
