## 問題 5.5 解答

### 階乗計算機

```scm
(controller
    (assign continue (label fact-done))
  fact-loop
    (test (op =) (reg n) (const 1))
    (branch (label base-case))
    (save continue)
    (save n)
    (assign n (op -) (reg n) (const 1))
    (assign continue (label after-fact))
    (goto (label fact-loop))
  after-fact
    (restore n)
    (restore continue)
    (assign val (op *) (reg n) (reg val))
    (goto (reg continue))
  base-case
    (assign val (const 1))
    (goto (reg continue))
  fact-done)
```

`(factorial 3)`の計算をシミュレーション。

```scm
start
  (assign continue (label fact-done))
fact-loop-1
  (test (op =) (reg n) (const 1))
  (save continue)
  (save n) ; stack:(3 fact-done)
  (assign n (op -) (reg n) (const 1))
  (assign continue (label after-fact))
fact-loop-2
  (test (op =) (reg n) (const 1))
  (save continue)
  (save n) ; stack:(2 after-fact 3 fact-done)
  (assign n (op -) (reg n) (const 1))
  (assign continue (label after-fact))
fact-loop-3
  (test (op =) (reg n) (const 1))
  (save continue)
  (save n) ; stack:(1 after-fact 2 after-fact 3 fact-done)
  (assign n (op -) (reg n) (const 1))
  (assign continue (label after-fact))
fact-loop-4
  (test (op =) (reg n) (const 1))
base-case
  (assign val (const 1))
after-fact-1
  (restore n) ; stack:(after-fact 2 after-fact 3 fact-done)
  (restore continue) ; stack:(2 after-fact 3 fact-done)
  (assign val (op *) (reg n) (reg val)) ; val => 1*1=1
after-fact-2
  (restore n) ; stack:(after-fact 3 fact-done)
  (restore continue) ; stack:(3 fact-done)
  (assign val (op *) (reg n) (reg val)) ; val => 1*2=2
after-fact-3
  (restore n) ; stack:(fact-done)
  (restore continue) ; stack:()
  (assign val (op *) (reg n) (reg val)) ; val => 2*3=6
fact-done
```
