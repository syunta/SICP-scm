# 問題 3.43 解答

## 最初の版を使って交換を実装した場合

Peterがa1とa2の交換、Paulがa1とa3の交換を試みる。

```
 Peter    a1    a2    a3     Paul

   +------10    20    30
   |
   V
get a1:10
   |
   +------------20
   |
   V
get a2:20
   |
   V
10-20=-10
   |      10------------------+
   |                          |
   |                       get a1:10
   |                          |
   |                  30------+
   |                          |
   |                          V
   |                       get a3:30
   |                          |
   |                          V
   |                       10-30=-20
   |                          |
   |      10------------------+
   |                          |
   |                          V
   |                       withdraw
   |                       get a1:10
   |                       10-(-20)=30
   |                       set a1:30
   |                          |
   |      30<-----------------+
   |                          |
   |                  30------+
   |                          |
   |                          V
   |                       deposit
   |                       get a3:30
   |                       30+(-20)=10
   |                       set a3:10
   |                          |
   |                  10<-----+
   +------30
   |
   V
withdraw
get a1:30
30-(-10)=40
set a1:40
   |
   +----->40
   |
   +------------20
   |
   V
deposit
get a2:20
20+(-10)=10
set a2:10
   |
   +----------->10

          40    10    10
```

10, 20, 30 の順序を破ることができた。

残高の合計は保存される。

## 直列化しない場合

Peterがa1とa2の交換、Paulがa1とa3の交換を試みる。

```
 Peter    a1    a2    a3     Paul

   +------10    20    30
   |
   V
get a1:10
   |
   +------------20
   |
   V
get a2:20
   |
   V
10-20=-10
   |
   +------10
   |
   V
withdraw
get a1:10
   |                       exchange a1 a3
   |                       set a1:30
   |                          |
   |      30<-----------------+
   |                          |
   |                          V
   |                       set a3:10
   |                          |
   |                  10<-----+
   V
10-(-10)=20
set a1:20
   |
   +----->20
   |
   +------------20
   |
   V
deposit
get a2:20
20+(-10)=10
set a2:10
   |
   +----------->10

          20    10    10
```

残高の合計が保存されることを破ることができた。
